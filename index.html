<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MH Manager">
    <title>Mobile Home Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background-color: #F2F2F7;
        }
        .ios-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .ios-input {
            background: #F2F2F7;
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 16px;
            width: 100%;
            outline: none;
        }
        .ios-input:focus {
            background: #E5E5EA;
        }
        .ios-button {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }
        .ios-button:active {
            opacity: 0.8;
        }
        .ios-button-secondary {
            background: #E5E5EA;
            color: #007AFF;
        }
        .ios-button-success {
            background: #34C759;
        }
        .ios-button-danger {
            background: #FF3B30;
        }
        .ios-segment {
            display: flex;
            background: #E5E5EA;
            border-radius: 9px;
            padding: 2px;
            overflow-x: auto;
        }
        .ios-segment button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }
        .ios-segment button.active {
            background: white;
            color: #000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            border-top: 0.5px solid #E5E5EA;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }
        select.ios-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        .status-inventory { background: #E5E5EA; color: #666; }
        .status-listed { background: #FFE58F; color: #8B6914; }
        .status-sold { background: #B7EB8F; color: #389E0D; }
        .status-financed { background: #91D5FF; color: #0050B3; }
        .status-paidoff { background: #D3ADF7; color: #531DAB; }
        .status-repo { background: #FFA39E; color: #A8071A; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-slide {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============== CONFIGURATION ==============
        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        const APP_PASSWORD = 'loan2024';
        const USERS = ['Ric', 'Vir', 'Derrick'];
        
        // Florida Late Fee Settings
        const LATE_FEE_PERCENT = 0.05;
        const GRACE_PERIOD_DAYS = 10;

        // ============== UTILITIES ==============
        const formatCurrency = (amt) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amt || 0);
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
        const formatDateInput = (d) => d ? new Date(d).toISOString().split('T')[0] : '';
        const today = () => formatDateInput(new Date());

        const calcMonthlyPayment = (principal, rate, months) => {
            if (!principal || !months) return 0;
            if (rate === 0) return principal / months;
            const r = rate / 12;
            return principal * (r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1);
        };

        // ============== ICONS ==============
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                home: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
                list: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
                dollar: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                chart: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
                more: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 6h16M4 12h16M4 18h16" /></svg>,
                plus: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
                back: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>,
                right: <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
                search: <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
                printer: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
                receipt: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" /></svg>,
                doc: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
                download: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
                x: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            };
            return icons[name] || null;
        };

        // ============== INITIAL DATA ==============
        const INITIAL_PROPERTIES = [
            {
                id: '1', address: '6018 Black Dairy Road, Seffner FL 33584', lotNumber: '2', parkName: 'Oak Trail',
                year: '1973', makeModel: 'APAC HS', vinSerial: 'F3651289', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 4840.75,
                holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash',
                salePrice: 8000, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: 'Romina',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '2', address: '11416 E US HWY 92, Seffner FL 33584', lotNumber: '23', parkName: 'Family Rental',
                year: '', makeModel: 'Mark HS', vinSerial: '126', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Kenyon Weiss', purchasePrice: 9250.50,
                holdingCosts: 0, renovationCosts: 0, status: 'Inventory',
                salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '3', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'B1', parkName: 'Twin Palms',
                year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 0,
                holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash',
                salePrice: 17000, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: 'Lola',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '4', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'B10', parkName: 'Twin Palms',
                year: '1970', makeModel: 'LBRT HS', vinSerial: 'G4084', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 9080.75,
                holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash',
                salePrice: 18900, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: 'Henil',
                contractDate: '', firstPaymentDue: '', notes: 'Profit $11,000 after interest', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '5', address: '11416 E US HWY 92, Seffner FL 33584', lotNumber: '11', parkName: 'Family Rental',
                year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 0,
                holdingCosts: 0, renovationCosts: 0, status: 'Inventory',
                salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '6', address: '12091 Emory Oak Loop, Thonotosassa FL', lotNumber: 'P13', parkName: 'Green Oaks',
                year: '1980', makeModel: 'Noma', vinSerial: '', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50,
                holdingCosts: 150, renovationCosts: 0, status: 'Sold-Cash',
                salePrice: 9500, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '7', address: '12010 Emory Oak Loop, Thonotosassa FL', lotNumber: '2P', parkName: 'Green Oaks',
                year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50,
                holdingCosts: 150, renovationCosts: 5892.42, status: 'Sold-Cash',
                salePrice: 16000, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: 'Michelle',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '8', address: '12003 Emory Oak Loop, Thonotosassa FL', lotNumber: '1A', parkName: 'Green Oaks',
                year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50,
                holdingCosts: 150, renovationCosts: 0, status: 'Inventory',
                salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '9', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'A1', parkName: 'Twin Palms',
                year: '', makeModel: 'Amer', vinSerial: '33730', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Sean Clark', purchasePrice: 3390.63,
                holdingCosts: 0, renovationCosts: 0, status: 'Inventory',
                salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            },
            {
                id: '10', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'A3', parkName: 'Twin Palms',
                year: '', makeModel: 'Kent', vinSerial: 'K5520', titleNumber: '',
                seller: 'Specialville Estates', purchaser: 'Sean Clark', purchasePrice: 2315.63,
                holdingCosts: 0, renovationCosts: 0, status: 'Inventory',
                salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0,
                amountFinanced: 0, monthlyPayment: 0, buyer: '',
                contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString()
            }
        ];

        // ============== DATA STORE ==============
        const useDataStore = () => {
            const [properties, setProperties] = useState([]);
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const saved = localStorage.getItem('mh_properties');
                const savedPay = localStorage.getItem('mh_payments');
                
                // Load initial data if no saved data exists
                if (saved) {
                    setProperties(JSON.parse(saved));
                } else {
                    setProperties(INITIAL_PROPERTIES);
                    localStorage.setItem('mh_properties', JSON.stringify(INITIAL_PROPERTIES));
                }
                
                if (savedPay) setPayments(JSON.parse(savedPay));
                setLoading(false);
                
                if (SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    syncFromCloud();
                }
            }, []);

            useEffect(() => {
                if (!loading) {
                    localStorage.setItem('mh_properties', JSON.stringify(properties));
                    localStorage.setItem('mh_payments', JSON.stringify(payments));
                }
            }, [properties, payments, loading]);

            const syncFromCloud = async () => {
                try {
                    const res = await fetch(`${SCRIPT_URL}?action=getAll`);
                    const data = await res.json();
                    if (data.success) {
                        if (data.properties) setProperties(data.properties);
                        if (data.payments) setPayments(data.payments);
                    }
                } catch (e) { console.error('Sync error:', e); }
            };

            const syncToCloud = async (type, data) => {
                if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') return;
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'save', type, data })
                    });
                } catch (e) { console.error('Save error:', e); }
            };

            const addProperty = async (prop) => {
                const newProp = { ...prop, id: Date.now().toString(), createdAt: new Date().toISOString() };
                setProperties(prev => [...prev, newProp]);
                await syncToCloud('property', newProp);
                return newProp;
            };

            const updateProperty = async (id, updates) => {
                setProperties(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p));
                const updated = properties.find(p => p.id === id);
                if (updated) await syncToCloud('property', { ...updated, ...updates });
            };

            const deleteProperty = (id) => {
                setProperties(prev => prev.filter(p => p.id !== id));
            };

            const addPayment = async (payment) => {
                const newPay = { ...payment, id: Date.now().toString(), createdAt: new Date().toISOString() };
                setPayments(prev => [...prev, newPay]);
                await syncToCloud('payment', newPay);
                return newPay;
            };

            const getPropertyPayments = (propId) => {
                return payments.filter(p => p.propertyId === propId).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            };

            const getBalance = (prop) => {
                if (!prop.amountFinanced) return 0;
                const propPayments = getPropertyPayments(prop.id);
                const totalPrincipal = propPayments.reduce((sum, p) => sum + (parseFloat(p.principal) || 0), 0);
                return Math.max(0, prop.amountFinanced - totalPrincipal);
            };

            const getTotalPaid = (prop) => {
                const propPayments = getPropertyPayments(prop.id);
                return propPayments.reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);
            };

            const getProfit = (prop) => {
                const salePrice = parseFloat(prop.salePrice) || 0;
                const purchasePrice = parseFloat(prop.purchasePrice) || 0;
                const holdingCosts = parseFloat(prop.holdingCosts) || 0;
                const renovationCosts = parseFloat(prop.renovationCosts) || 0;
                return salePrice - purchasePrice - holdingCosts - renovationCosts;
            };

            return {
                properties, payments, loading,
                addProperty, updateProperty, deleteProperty,
                addPayment, getPropertyPayments, getBalance, getTotalPaid, getProfit,
                syncFromCloud
            };
        };

        // ============== LOGIN ==============
        const Login = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');

            const handleLogin = () => {
                if (pass === APP_PASSWORD && user) {
                    localStorage.setItem('mh_user', user);
                    localStorage.setItem('mh_auth', 'true');
                    onLogin(user);
                } else {
                    setError('Invalid password or select user');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-blue-500 to-blue-600 flex items-center justify-center p-6">
                    <div className="ios-card p-8 w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">üè†</div>
                            <h1 className="text-2xl font-bold">Mobile Home Manager</h1>
                            <p className="text-gray-500 text-sm mt-1">Seller Finance Tracker</p>
                        </div>
                        <div className="space-y-4">
                            <select className="ios-input" value={user} onChange={e => setUser(e.target.value)}>
                                <option value="">Select user...</option>
                                {USERS.map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                            <input type="password" className="ios-input" placeholder="Password" value={pass} 
                                onChange={e => setPass(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleLogin()} />
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button className="ios-button" onClick={handleLogin}>Sign In</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== HEADER ==============
        const Header = ({ title, showBack, onBack, right }) => (
            <div className="bg-white/95 sticky top-0 z-40 border-b border-gray-200 backdrop-blur">
                <div className="flex items-center justify-between px-4 py-3">
                    <div className="flex items-center">
                        {showBack && <button onClick={onBack} className="mr-2 -ml-2 p-2 text-blue-500"><Icon name="back" /></button>}
                        <h1 className="text-xl font-bold">{title}</h1>
                    </div>
                    {right}
                </div>
            </div>
        );

        // ============== TAB BAR ==============
        const TabBar = ({ active, onChange }) => {
            const tabs = [
                { id: 'dashboard', label: 'Dashboard', icon: 'home' },
                { id: 'properties', label: 'Properties', icon: 'list' },
                { id: 'payments', label: 'Payments', icon: 'dollar' },
                { id: 'reports', label: 'Reports', icon: 'chart' },
                { id: 'more', label: 'More', icon: 'more' },
            ];
            return (
                <div className="tab-bar no-print">
                    <div className="flex justify-around py-2">
                        {tabs.map(t => (
                            <button key={t.id} onClick={() => onChange(t.id)}
                                className={`flex flex-col items-center px-3 py-1 ${active === t.id ? 'text-blue-500' : 'text-gray-400'}`}>
                                <Icon name={t.icon} />
                                <span className="text-xs mt-1">{t.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // ============== DASHBOARD ==============
        const Dashboard = ({ store, onViewProperty }) => {
            const { properties, payments, getBalance, getProfit } = store;
            
            const inventory = properties.filter(p => p.status === 'Inventory');
            const listed = properties.filter(p => p.status === 'Listed');
            const soldCash = properties.filter(p => p.status === 'Sold-Cash');
            const financed = properties.filter(p => p.status === 'Financed');
            const paidOff = properties.filter(p => p.status === 'Paid Off');
            
            const totalInvested = properties.reduce((sum, p) => sum + (parseFloat(p.purchasePrice) || 0) + (parseFloat(p.renovationCosts) || 0) + (parseFloat(p.holdingCosts) || 0), 0);
            const totalSales = properties.filter(p => p.salePrice).reduce((sum, p) => sum + (parseFloat(p.salePrice) || 0), 0);
            const totalProfit = properties.filter(p => p.salePrice).reduce((sum, p) => sum + getProfit(p), 0);
            const totalOutstanding = financed.reduce((sum, p) => sum + getBalance(p), 0);
            const totalCollected = payments.reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && properties.length > 0) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'doughnut',
                        data: {
                            labels: ['Inventory', 'Listed', 'Sold Cash', 'Financed', 'Paid Off'],
                            datasets: [{
                                data: [inventory.length, listed.length, soldCash.length, financed.length, paidOff.length],
                                backgroundColor: ['#8E8E93', '#FFCC00', '#34C759', '#007AFF', '#AF52DE']
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [properties]);

            return (
                <div className="pb-24">
                    <Header title="Dashboard" />
                    <div className="p-4 space-y-4">
                        {/* Stats */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="ios-card p-4">
                                <p className="text-xs text-gray-500 uppercase">Total Properties</p>
                                <p className="text-2xl font-bold">{properties.length}</p>
                            </div>
                            <div className="ios-card p-4">
                                <p className="text-xs text-gray-500 uppercase">Active Financing</p>
                                <p className="text-2xl font-bold text-blue-500">{financed.length}</p>
                            </div>
                            <div className="ios-card p-4">
                                <p className="text-xs text-gray-500 uppercase">Outstanding</p>
                                <p className="text-2xl font-bold text-orange-500">{formatCurrency(totalOutstanding)}</p>
                            </div>
                            <div className="ios-card p-4">
                                <p className="text-xs text-gray-500 uppercase">Total Profit</p>
                                <p className="text-2xl font-bold text-green-500">{formatCurrency(totalProfit)}</p>
                            </div>
                        </div>

                        {/* Chart */}
                        {properties.length > 0 && (
                            <div className="ios-card p-4">
                                <h3 className="font-semibold mb-4">Properties by Status</h3>
                                <canvas ref={chartRef} height="200"></canvas>
                            </div>
                        )}

                        {/* Financial Summary */}
                        <div className="ios-card">
                            <div className="p-4 border-b border-gray-100">
                                <h3 className="font-semibold">Financial Summary</h3>
                            </div>
                            <div className="divide-y divide-gray-100">
                                <div className="flex justify-between p-4">
                                    <span className="text-gray-600">Total Invested</span>
                                    <span className="font-medium">{formatCurrency(totalInvested)}</span>
                                </div>
                                <div className="flex justify-between p-4">
                                    <span className="text-gray-600">Total Sales</span>
                                    <span className="font-medium">{formatCurrency(totalSales)}</span>
                                </div>
                                <div className="flex justify-between p-4">
                                    <span className="text-gray-600">Payments Collected</span>
                                    <span className="font-medium text-green-600">{formatCurrency(totalCollected)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Recent Properties */}
                        {financed.length > 0 && (
                            <div className="ios-card">
                                <div className="p-4 border-b border-gray-100">
                                    <h3 className="font-semibold">Active Financing</h3>
                                </div>
                                {financed.slice(0, 5).map(prop => (
                                    <div key={prop.id} className="flex items-center p-4 border-b border-gray-100 last:border-0 cursor-pointer"
                                        onClick={() => onViewProperty(prop)}>
                                        <div className="flex-1">
                                            <p className="font-medium">{prop.buyer || 'No Buyer'}</p>
                                            <p className="text-sm text-gray-500">{prop.address}</p>
                                        </div>
                                        <div className="text-right mr-2">
                                            <p className="font-medium">{formatCurrency(getBalance(prop))}</p>
                                            <p className="text-xs text-gray-400">balance</p>
                                        </div>
                                        <Icon name="right" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ============== PROPERTY LIST ==============
        const PropertyList = ({ store, onView, onAdd }) => {
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            const { properties, getBalance, getProfit } = store;

            const filtered = properties.filter(p => {
                const matchSearch = (p.address || '').toLowerCase().includes(search.toLowerCase()) ||
                    (p.buyer || '').toLowerCase().includes(search.toLowerCase()) ||
                    (p.parkName || '').toLowerCase().includes(search.toLowerCase());
                const matchFilter = filter === 'all' || p.status === filter;
                return matchSearch && matchFilter;
            });

            const getStatusClass = (status) => {
                const classes = {
                    'Inventory': 'status-inventory',
                    'Listed': 'status-listed',
                    'Sold-Cash': 'status-sold',
                    'Financed': 'status-financed',
                    'Paid Off': 'status-paidoff',
                    'Repo': 'status-repo'
                };
                return classes[status] || 'status-inventory';
            };

            return (
                <div className="pb-24">
                    <Header title="Properties" right={
                        <button onClick={onAdd} className="p-2 text-blue-500"><Icon name="plus" /></button>
                    } />
                    <div className="p-4 space-y-3">
                        <div className="relative">
                            <div className="absolute left-3 top-1/2 -translate-y-1/2"><Icon name="search" /></div>
                            <input className="ios-input pl-10" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} />
                        </div>
                        <div className="ios-segment">
                            {['all', 'Inventory', 'Listed', 'Financed', 'Sold-Cash', 'Paid Off', 'Repo'].map(f => (
                                <button key={f} className={filter === f ? 'active' : ''} onClick={() => setFilter(f)}>
                                    {f === 'all' ? 'All' : f}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="px-4 space-y-3">
                        {filtered.length === 0 ? (
                            <div className="ios-card p-8 text-center">
                                <p className="text-gray-500">No properties found</p>
                                <button className="text-blue-500 mt-2" onClick={onAdd}>Add your first property</button>
                            </div>
                        ) : filtered.map(prop => (
                            <div key={prop.id} className="ios-card p-4 cursor-pointer active:bg-gray-50" onClick={() => onView(prop)}>
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <p className="font-semibold">{prop.address}</p>
                                        <p className="text-sm text-gray-500">{prop.parkName} {prop.lotNumber ? `Lot ${prop.lotNumber}` : ''}</p>
                                        {prop.buyer && <p className="text-sm text-blue-600 mt-1">Buyer: {prop.buyer}</p>}
                                    </div>
                                    <div className="text-right">
                                        <span className={`text-xs px-2 py-1 rounded-full ${getStatusClass(prop.status)}`}>{prop.status}</span>
                                        {prop.status === 'Financed' && (
                                            <p className="text-lg font-bold mt-1">{formatCurrency(getBalance(prop))}</p>
                                        )}
                                        {prop.salePrice && prop.status !== 'Financed' && (
                                            <p className="text-sm text-green-600 mt-1">+{formatCurrency(getProfit(prop))}</p>
                                        )}
                                    </div>
                                </div>
                                <div className="flex justify-between mt-3 pt-3 border-t border-gray-100 text-sm text-gray-500">
                                    <span>Purchase: {formatCurrency(prop.purchasePrice)}</span>
                                    {prop.salePrice && <span>Sale: {formatCurrency(prop.salePrice)}</span>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ============== ADD/EDIT PROPERTY ==============
        const PropertyForm = ({ property, onSave, onCancel, currentUser }) => {
            const [form, setForm] = useState(property || {
                address: '', lotNumber: '', parkName: '',
                year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: '', purchaser: '', purchasePrice: '',
                holdingCosts: '', renovationCosts: '',
                status: 'Inventory',
                salePrice: '', downPayment: '', interestRate: '0', termMonths: '',
                buyer: '', contractDate: today(), firstPaymentDue: '',
                notes: '', enteredBy: currentUser
            });

            const handleChange = (field, value) => setForm(prev => ({ ...prev, [field]: value }));

            const handleSave = () => {
                const amountFinanced = (parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0);
                const monthlyPayment = form.status === 'Financed' ? 
                    calcMonthlyPayment(amountFinanced, parseFloat(form.interestRate || 0) / 100, parseInt(form.termMonths || 1)) : 0;
                
                onSave({
                    ...form,
                    purchasePrice: parseFloat(form.purchasePrice) || 0,
                    holdingCosts: parseFloat(form.holdingCosts) || 0,
                    renovationCosts: parseFloat(form.renovationCosts) || 0,
                    salePrice: parseFloat(form.salePrice) || 0,
                    downPayment: parseFloat(form.downPayment) || 0,
                    interestRate: parseFloat(form.interestRate || 0) / 100,
                    termMonths: parseInt(form.termMonths) || 0,
                    amountFinanced,
                    monthlyPayment
                });
            };

            const isValid = form.address;

            return (
                <div className="fixed inset-0 bg-white z-50 overflow-auto modal-slide">
                    <Header title={property ? "Edit Property" : "Add Property"} showBack onBack={onCancel}
                        right={<button onClick={handleSave} disabled={!isValid} 
                            className={`font-semibold ${isValid ? 'text-blue-500' : 'text-gray-300'}`}>Save</button>} />
                    
                    <div className="p-4 pb-8 space-y-6">
                        {/* Property Info */}
                        <div className="ios-card p-4">
                            <h3 className="font-semibold text-gray-500 text-sm uppercase mb-4">Property Information</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">Address *</label>
                                    <input className="ios-input" value={form.address} onChange={e => handleChange('address', e.target.value)} placeholder="Full address" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Park Name</label>
                                        <input className="ios-input" value={form.parkName} onChange={e => handleChange('parkName', e.target.value)} placeholder="Mobile Home Park" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Lot #</label>
                                        <input className="ios-input" value={form.lotNumber} onChange={e => handleChange('lotNumber', e.target.value)} placeholder="Lot number" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Year</label>
                                        <input className="ios-input" value={form.year} onChange={e => handleChange('year', e.target.value)} placeholder="1980" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Make/Model</label>
                                        <input className="ios-input" value={form.makeModel} onChange={e => handleChange('makeModel', e.target.value)} placeholder="Clayton 16x80" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">VIN/Serial</label>
                                        <input className="ios-input" value={form.vinSerial} onChange={e => handleChange('vinSerial', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Title #</label>
                                        <input className="ios-input" value={form.titleNumber} onChange={e => handleChange('titleNumber', e.target.value)} />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Purchase Info */}
                        <div className="ios-card p-4">
                            <h3 className="font-semibold text-gray-500 text-sm uppercase mb-4">Purchase Information</h3>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Seller</label>
                                        <input className="ios-input" value={form.seller} onChange={e => handleChange('seller', e.target.value)} placeholder="Who sold to you" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Purchaser</label>
                                        <input className="ios-input" value={form.purchaser} onChange={e => handleChange('purchaser', e.target.value)} placeholder="Your entity name" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">Purchase Price</label>
                                    <input className="ios-input" type="number" step="0.01" value={form.purchasePrice} onChange={e => handleChange('purchasePrice', e.target.value)} placeholder="0.00" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Holding Costs</label>
                                        <input className="ios-input" type="number" step="0.01" value={form.holdingCosts} onChange={e => handleChange('holdingCosts', e.target.value)} placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Renovation Costs</label>
                                        <input className="ios-input" type="number" step="0.01" value={form.renovationCosts} onChange={e => handleChange('renovationCosts', e.target.value)} placeholder="0.00" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Status */}
                        <div className="ios-card p-4">
                            <h3 className="font-semibold text-gray-500 text-sm uppercase mb-4">Status</h3>
                            <select className="ios-input" value={form.status} onChange={e => handleChange('status', e.target.value)}>
                                <option value="Inventory">Inventory</option>
                                <option value="Listed">Listed</option>
                                <option value="Sold-Cash">Sold - Cash</option>
                                <option value="Financed">Financed (Seller Finance)</option>
                                <option value="Paid Off">Paid Off</option>
                                <option value="Repo">Repo</option>
                            </select>
                        </div>

                        {/* Sale Info */}
                        {(form.status === 'Sold-Cash' || form.status === 'Financed' || form.status === 'Paid Off') && (
                            <div className="ios-card p-4">
                                <h3 className="font-semibold text-gray-500 text-sm uppercase mb-4">Sale Information</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Buyer Name</label>
                                        <input className="ios-input" value={form.buyer} onChange={e => handleChange('buyer', e.target.value)} placeholder="End buyer name" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Sale Price</label>
                                            <input className="ios-input" type="number" step="0.01" value={form.salePrice} onChange={e => handleChange('salePrice', e.target.value)} placeholder="0.00" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Down Payment</label>
                                            <input className="ios-input" type="number" step="0.01" value={form.downPayment} onChange={e => handleChange('downPayment', e.target.value)} placeholder="0.00" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Financing Terms */}
                        {form.status === 'Financed' && (
                            <div className="ios-card p-4">
                                <h3 className="font-semibold text-gray-500 text-sm uppercase mb-4">Financing Terms</h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Interest Rate (%)</label>
                                            <input className="ios-input" type="number" step="0.1" value={form.interestRate} onChange={e => handleChange('interestRate', e.target.value)} placeholder="0" />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Term (Months)</label>
                                            <input className="ios-input" type="number" value={form.termMonths} onChange={e => handleChange('termMonths', e.target.value)} placeholder="24" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Contract Date</label>
                                            <input className="ios-input" type="date" value={form.contractDate} onChange={e => handleChange('contractDate', e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">First Payment Due</label>
                                            <input className="ios-input" type="date" value={form.firstPaymentDue} onChange={e => handleChange('firstPaymentDue', e.target.value)} />
                                        </div>
                                    </div>
                                    
                                    {/* Calculated */}
                                    {form.salePrice && form.termMonths && (
                                        <div className="bg-blue-50 rounded-lg p-4 space-y-2">
                                            <div className="flex justify-between">
                                                <span>Amount Financed:</span>
                                                <span className="font-semibold">{formatCurrency((parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0))}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span>Monthly Payment:</span>
                                                <span className="font-bold text-blue-600">
                                                    {formatCurrency(calcMonthlyPayment(
                                                        (parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0),
                                                        parseFloat(form.interestRate || 0) / 100,
                                                        parseInt(form.termMonths || 1)
                                                    ))}
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Notes */}
                        <div className="ios-card p-4">
                            <label className="block text-sm text-gray-600 mb-1">Notes</label>
                            <textarea className="ios-input" rows="3" value={form.notes} onChange={e => handleChange('notes', e.target.value)} placeholder="Additional notes..." />
                        </div>

                        {/* Profit Preview */}
                        {form.salePrice && form.purchasePrice && (
                            <div className="ios-card p-4 bg-green-50">
                                <h3 className="font-semibold text-green-800 mb-2">Profit Preview</h3>
                                <div className="text-2xl font-bold text-green-600">
                                    {formatCurrency(
                                        (parseFloat(form.salePrice) || 0) - 
                                        (parseFloat(form.purchasePrice) || 0) - 
                                        (parseFloat(form.holdingCosts) || 0) - 
                                        (parseFloat(form.renovationCosts) || 0)
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ============== PROPERTY DETAIL ==============
        const PropertyDetail = ({ property, store, onBack, onEdit, onAddPayment, currentUser }) => {
            const { getBalance, getTotalPaid, getProfit, getPropertyPayments, updateProperty } = store;
            const payments = getPropertyPayments(property.id);
            const balance = getBalance(property);
            const totalPaid = getTotalPaid(property);
            const profit = getProfit(property);
            
            const [showReceipt, setShowReceipt] = useState(null);
            const [showStatement, setShowStatement] = useState(false);

            const paymentsCount = payments.length;
            const nextDue = property.firstPaymentDue ? new Date(property.firstPaymentDue) : new Date();
            if (property.firstPaymentDue) nextDue.setMonth(nextDue.getMonth() + paymentsCount);

            return (
                <div className="fixed inset-0 bg-gray-100 z-50 overflow-auto modal-slide">
                    <Header title="Property Details" showBack onBack={onBack} right={
                        <button onClick={() => onEdit(property)} className="text-blue-500 font-medium">Edit</button>
                    } />
                    
                    <div className="p-4 pb-8 space-y-4">
                        {/* Status Card */}
                        <div className="ios-card p-6 text-center">
                            <p className="text-gray-500 text-sm">{property.status === 'Financed' ? 'Current Balance' : 'Profit'}</p>
                            <p className="text-4xl font-bold mt-1">
                                {property.status === 'Financed' ? formatCurrency(balance) : formatCurrency(profit)}
                            </p>
                            <span className={`inline-block mt-3 px-3 py-1 rounded-full text-sm font-medium
                                ${property.status === 'Financed' ? 'bg-blue-100 text-blue-700' : 
                                  property.status === 'Inventory' ? 'bg-gray-100 text-gray-700' :
                                  property.status === 'Paid Off' ? 'bg-purple-100 text-purple-700' :
                                  'bg-green-100 text-green-700'}`}>
                                {property.status}
                            </span>
                        </div>

                        {/* Quick Actions */}
                        {property.status === 'Financed' && (
                            <div className="grid grid-cols-3 gap-3">
                                <button className="ios-card p-3 text-center" onClick={onAddPayment}>
                                    <Icon name="dollar" className="w-6 h-6 mx-auto text-green-500" />
                                    <p className="text-xs mt-1">Payment</p>
                                </button>
                                <button className="ios-card p-3 text-center" onClick={() => setShowStatement(true)}>
                                    <Icon name="doc" className="w-6 h-6 mx-auto text-blue-500" />
                                    <p className="text-xs mt-1">Statement</p>
                                </button>
                                <button className="ios-card p-3 text-center" onClick={() => payments.length > 0 && setShowReceipt(payments[payments.length - 1])}>
                                    <Icon name="receipt" className="w-6 h-6 mx-auto text-purple-500" />
                                    <p className="text-xs mt-1">Receipt</p>
                                </button>
                            </div>
                        )}

                        {/* Property Info */}
                        <div className="ios-card">
                            <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Property</h3></div>
                            <div className="p-4 space-y-3 text-sm">
                                <div className="flex justify-between"><span className="text-gray-500">Address</span><span className="font-medium text-right">{property.address}</span></div>
                                <div className="flex justify-between"><span className="text-gray-500">Park / Lot</span><span className="font-medium">{property.parkName} {property.lotNumber ? `#${property.lotNumber}` : ''}</span></div>
                                {property.year && <div className="flex justify-between"><span className="text-gray-500">Year</span><span className="font-medium">{property.year}</span></div>}
                                {property.makeModel && <div className="flex justify-between"><span className="text-gray-500">Make/Model</span><span className="font-medium">{property.makeModel}</span></div>}
                                {property.vinSerial && <div className="flex justify-between"><span className="text-gray-500">VIN/Serial</span><span className="font-medium">{property.vinSerial}</span></div>}
                            </div>
                        </div>

                        {/* Purchase Info */}
                        <div className="ios-card">
                            <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Purchase</h3></div>
                            <div className="p-4 space-y-3 text-sm">
                                {property.seller && <div className="flex justify-between"><span className="text-gray-500">Seller</span><span className="font-medium">{property.seller}</span></div>}
                                {property.purchaser && <div className="flex justify-between"><span className="text-gray-500">Purchaser</span><span className="font-medium">{property.purchaser}</span></div>}
                                <div className="flex justify-between"><span className="text-gray-500">Purchase Price</span><span className="font-medium">{formatCurrency(property.purchasePrice)}</span></div>
                                {property.holdingCosts > 0 && <div className="flex justify-between"><span className="text-gray-500">Holding Costs</span><span className="font-medium">{formatCurrency(property.holdingCosts)}</span></div>}
                                {property.renovationCosts > 0 && <div className="flex justify-between"><span className="text-gray-500">Renovation</span><span className="font-medium">{formatCurrency(property.renovationCosts)}</span></div>}
                                <div className="flex justify-between pt-2 border-t border-gray-100"><span className="text-gray-500 font-medium">Total Investment</span><span className="font-bold">{formatCurrency((property.purchasePrice || 0) + (property.holdingCosts || 0) + (property.renovationCosts || 0))}</span></div>
                            </div>
                        </div>

                        {/* Sale Info */}
                        {property.salePrice > 0 && (
                            <div className="ios-card">
                                <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Sale</h3></div>
                                <div className="p-4 space-y-3 text-sm">
                                    {property.buyer && <div className="flex justify-between"><span className="text-gray-500">Buyer</span><span className="font-medium">{property.buyer}</span></div>}
                                    <div className="flex justify-between"><span className="text-gray-500">Sale Price</span><span className="font-medium">{formatCurrency(property.salePrice)}</span></div>
                                    {property.downPayment > 0 && <div className="flex justify-between"><span className="text-gray-500">Down Payment</span><span className="font-medium">{formatCurrency(property.downPayment)}</span></div>}
                                    <div className="flex justify-between pt-2 border-t border-gray-100"><span className="text-gray-500 font-medium">Profit</span><span className="font-bold text-green-600">{formatCurrency(profit)}</span></div>
                                </div>
                            </div>
                        )}

                        {/* Financing Terms */}
                        {property.status === 'Financed' && (
                            <div className="ios-card">
                                <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Financing</h3></div>
                                <div className="p-4 space-y-3 text-sm">
                                    <div className="flex justify-between"><span className="text-gray-500">Amount Financed</span><span className="font-medium">{formatCurrency(property.amountFinanced)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Interest Rate</span><span className="font-medium">{((property.interestRate || 0) * 100).toFixed(1)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Term</span><span className="font-medium">{property.termMonths} months</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Monthly Payment</span><span className="font-bold text-blue-600">{formatCurrency(property.monthlyPayment)}</span></div>
                                    <div className="flex justify-between pt-2 border-t border-gray-100"><span className="text-gray-500">Payments Made</span><span className="font-medium">{paymentsCount} of {property.termMonths}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Total Paid</span><span className="font-medium text-green-600">{formatCurrency(totalPaid)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Next Due</span><span className="font-medium">{formatDate(nextDue)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Balance</span><span className="font-bold">{formatCurrency(balance)}</span></div>
                                </div>
                            </div>
                        )}

                        {/* Payment History */}
                        {payments.length > 0 && (
                            <div className="ios-card">
                                <div className="p-4 border-b border-gray-100 flex justify-between">
                                    <h3 className="font-semibold">Payment History</h3>
                                    <span className="text-sm text-gray-500">{payments.length} payments</span>
                                </div>
                                {payments.slice().reverse().map(pay => (
                                    <div key={pay.id} className="flex items-center p-4 border-b border-gray-100 last:border-0 cursor-pointer"
                                        onClick={() => setShowReceipt(pay)}>
                                        <div className="flex-1">
                                            <p className="font-medium">{formatCurrency(pay.amountPaid)}</p>
                                            <p className="text-sm text-gray-500">{pay.paymentMethod} ‚Ä¢ {formatDate(pay.dateReceived)}</p>
                                        </div>
                                        <span className={`text-sm ${pay.daysLate > 0 ? 'text-orange-500' : 'text-green-500'}`}>
                                            {pay.daysLate > 0 ? `${pay.daysLate}d late` : 'On time'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Notes */}
                        {property.notes && (
                            <div className="ios-card p-4">
                                <h3 className="font-semibold mb-2">Notes</h3>
                                <p className="text-gray-600 text-sm">{property.notes}</p>
                            </div>
                        )}
                    </div>

                    {/* Receipt Modal */}
                    {showReceipt && (
                        <Receipt payment={showReceipt} property={property} onClose={() => setShowReceipt(null)} />
                    )}

                    {/* Statement Modal */}
                    {showStatement && (
                        <Statement property={property} payments={payments} balance={balance} onClose={() => setShowStatement(false)} />
                    )}
                </div>
            );
        };

        // ============== ADD PAYMENT ==============
        const PaymentForm = ({ property, properties, store, onSave, onCancel, currentUser }) => {
            const [selectedId, setSelectedId] = useState(property?.id || '');
            const selected = property || properties.find(p => p.id === selectedId);
            
            const [form, setForm] = useState({
                dueDate: today(),
                dateReceived: today(),
                amountPaid: selected?.monthlyPayment?.toFixed(2) || '',
                paymentMethod: 'Zelle',
                notes: '',
                enteredBy: currentUser
            });

            useEffect(() => {
                if (selected) setForm(prev => ({ ...prev, amountPaid: selected.monthlyPayment?.toFixed(2) || '' }));
            }, [selectedId]);

            const handleSave = () => {
                if (!selected) return;
                const balance = store.getBalance(selected);
                const daysLate = Math.max(0, Math.floor((new Date(form.dateReceived) - new Date(form.dueDate)) / (1000 * 60 * 60 * 24)));
                const lateFee = daysLate > GRACE_PERIOD_DAYS ? Math.min(selected.monthlyPayment * LATE_FEE_PERCENT, selected.monthlyPayment) : 0;
                const interest = selected.interestRate > 0 ? balance * (selected.interestRate / 12) : 0;
                const principal = Math.max(0, parseFloat(form.amountPaid) - interest - lateFee);

                onSave({
                    ...form,
                    propertyId: selected.id,
                    buyerName: selected.buyer,
                    amountPaid: parseFloat(form.amountPaid),
                    interest, principal, lateFee, daysLate,
                    beginningBalance: balance,
                    endingBalance: Math.max(0, balance - principal)
                });
            };

            const financedProps = properties.filter(p => p.status === 'Financed');
            const isValid = selected && form.dueDate && form.dateReceived && form.amountPaid;

            return (
                <div className="fixed inset-0 bg-white z-50 overflow-auto modal-slide">
                    <Header title="Log Payment" showBack onBack={onCancel}
                        right={<button onClick={handleSave} disabled={!isValid} 
                            className={`font-semibold ${isValid ? 'text-blue-500' : 'text-gray-300'}`}>Save</button>} />
                    
                    <div className="p-4 pb-8 space-y-4">
                        {!property && (
                            <div className="ios-card p-4">
                                <label className="block text-sm text-gray-600 mb-2">Select Property *</label>
                                <select className="ios-input" value={selectedId} onChange={e => setSelectedId(e.target.value)}>
                                    <option value="">Choose...</option>
                                    {financedProps.map(p => <option key={p.id} value={p.id}>{p.buyer} - {p.address}</option>)}
                                </select>
                            </div>
                        )}

                        {selected && (
                            <>
                                <div className="ios-card p-4">
                                    <p className="font-semibold">{selected.buyer}</p>
                                    <p className="text-sm text-gray-500">{selected.address}</p>
                                    <div className="flex justify-between mt-3 pt-3 border-t border-gray-100">
                                        <span className="text-gray-500">Balance</span>
                                        <span className="font-semibold">{formatCurrency(store.getBalance(selected))}</span>
                                    </div>
                                    <div className="flex justify-between mt-2">
                                        <span className="text-gray-500">Monthly Payment</span>
                                        <span className="font-bold text-blue-500">{formatCurrency(selected.monthlyPayment)}</span>
                                    </div>
                                </div>

                                <div className="ios-card p-4 space-y-4">
                                    <h3 className="font-semibold text-gray-500 text-sm uppercase">Payment Details</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Due Date</label>
                                            <input className="ios-input" type="date" value={form.dueDate} onChange={e => setForm({...form, dueDate: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">Date Received</label>
                                            <input className="ios-input" type="date" value={form.dateReceived} onChange={e => setForm({...form, dateReceived: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Amount Paid</label>
                                        <input className="ios-input" type="number" step="0.01" value={form.amountPaid} onChange={e => setForm({...form, amountPaid: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Payment Method</label>
                                        <select className="ios-input" value={form.paymentMethod} onChange={e => setForm({...form, paymentMethod: e.target.value})}>
                                            {['Cash', 'Zelle', 'Check', 'Money Order', 'Venmo', 'CashApp', 'Bank Transfer', 'Other'].map(m => 
                                                <option key={m} value={m}>{m}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm text-gray-600 mb-1">Notes</label>
                                        <input className="ios-input" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} placeholder="Optional" />
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // ============== PAYMENT LIST ==============
        const PaymentList = ({ store, onAddPayment }) => {
            const [search, setSearch] = useState('');
            const sorted = [...store.payments].sort((a, b) => new Date(b.dateReceived) - new Date(a.dateReceived));
            const filtered = sorted.filter(p => (p.buyerName || '').toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="pb-24">
                    <Header title="Payments" right={
                        <button onClick={onAddPayment} className="p-2 text-blue-500"><Icon name="plus" /></button>
                    } />
                    <div className="p-4">
                        <div className="relative">
                            <div className="absolute left-3 top-1/2 -translate-y-1/2"><Icon name="search" /></div>
                            <input className="ios-input pl-10" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} />
                        </div>
                    </div>
                    <div className="px-4">
                        {filtered.length === 0 ? (
                            <div className="ios-card p-8 text-center text-gray-500">No payments found</div>
                        ) : (
                            <div className="ios-card">
                                {filtered.map(pay => (
                                    <div key={pay.id} className="flex items-center p-4 border-b border-gray-100 last:border-0">
                                        <div className="flex-1">
                                            <p className="font-medium">{pay.buyerName || 'Unknown'}</p>
                                            <p className="text-sm text-gray-500">{pay.paymentMethod} ‚Ä¢ {formatDate(pay.dateReceived)}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="font-semibold">{formatCurrency(pay.amountPaid)}</p>
                                            <p className="text-xs text-gray-400">by {pay.enteredBy}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ============== RECEIPT ==============
        const Receipt = ({ payment, property, onClose }) => {
            const handlePrint = () => window.print();
            
            return (
                <div className="fixed inset-0 bg-black/50 z-60 flex items-end sm:items-center justify-center">
                    <div className="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-xl modal-slide">
                        <div className="p-4 border-b border-gray-200 flex justify-between items-center no-print">
                            <h2 className="text-lg font-bold">Payment Receipt</h2>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        
                        <div className="p-6" id="receipt-content">
                            <div className="text-center mb-6">
                                <h1 className="text-2xl font-bold">PAYMENT RECEIPT</h1>
                                <p className="text-gray-500">Specialville Estates</p>
                            </div>
                            
                            <div className="border-t border-b border-gray-200 py-4 my-4">
                                <div className="grid grid-cols-2 gap-2 text-sm">
                                    <div><span className="text-gray-500">Date:</span></div>
                                    <div className="text-right font-medium">{formatDate(payment.dateReceived)}</div>
                                    <div><span className="text-gray-500">Receipt #:</span></div>
                                    <div className="text-right font-medium">{payment.id?.slice(-8).toUpperCase()}</div>
                                </div>
                            </div>
                            
                            <div className="mb-4">
                                <p className="text-sm text-gray-500">Received From:</p>
                                <p className="font-semibold">{property.buyer}</p>
                                <p className="text-sm text-gray-600">{property.address}</p>
                            </div>
                            
                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                <div className="flex justify-between mb-2">
                                    <span>Payment Due:</span>
                                    <span>{formatDate(payment.dueDate)}</span>
                                </div>
                                <div className="flex justify-between mb-2">
                                    <span>Method:</span>
                                    <span>{payment.paymentMethod}</span>
                                </div>
                                <div className="border-t border-gray-200 my-2 pt-2">
                                    <div className="flex justify-between text-sm">
                                        <span>Principal:</span>
                                        <span>{formatCurrency(payment.principal)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span>Interest:</span>
                                        <span>{formatCurrency(payment.interest)}</span>
                                    </div>
                                    {payment.lateFee > 0 && (
                                        <div className="flex justify-between text-sm text-orange-600">
                                            <span>Late Fee:</span>
                                            <span>{formatCurrency(payment.lateFee)}</span>
                                        </div>
                                    )}
                                </div>
                                <div className="border-t border-gray-300 mt-2 pt-2 flex justify-between font-bold text-lg">
                                    <span>Amount Paid:</span>
                                    <span className="text-green-600">{formatCurrency(payment.amountPaid)}</span>
                                </div>
                            </div>
                            
                            <div className="text-sm text-gray-500 text-center">
                                <p>Remaining Balance: {formatCurrency(payment.endingBalance)}</p>
                            </div>
                        </div>
                        
                        <div className="p-4 border-t border-gray-200 no-print">
                            <button className="ios-button ios-button-secondary flex items-center justify-center gap-2" onClick={handlePrint}>
                                <Icon name="printer" className="w-5 h-5" /> Print Receipt
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== STATEMENT ==============
        const Statement = ({ property, payments, balance, onClose }) => {
            const handlePrint = () => window.print();
            const totalPaid = payments.reduce((sum, p) => sum + (p.amountPaid || 0), 0);
            const paymentsCount = payments.length;
            const nextDue = property.firstPaymentDue ? new Date(property.firstPaymentDue) : new Date();
            if (property.firstPaymentDue) nextDue.setMonth(nextDue.getMonth() + paymentsCount);

            return (
                <div className="fixed inset-0 bg-black/50 z-60 flex items-end sm:items-center justify-center">
                    <div className="bg-white w-full sm:max-w-lg sm:rounded-xl rounded-t-xl modal-slide max-h-[90vh] overflow-auto">
                        <div className="p-4 border-b border-gray-200 flex justify-between items-center no-print sticky top-0 bg-white">
                            <h2 className="text-lg font-bold">Monthly Statement</h2>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        
                        <div className="p-6">
                            <div className="text-center mb-6">
                                <h1 className="text-2xl font-bold">MONTHLY STATEMENT</h1>
                                <p className="text-gray-500">Specialville Estates</p>
                                <p className="text-sm text-gray-400">{formatDate(new Date())}</p>
                            </div>
                            
                            <div className="mb-6">
                                <p className="text-sm text-gray-500">Account Holder:</p>
                                <p className="font-semibold text-lg">{property.buyer}</p>
                                <p className="text-gray-600">{property.address}</p>
                                <p className="text-gray-500 text-sm">{property.parkName} {property.lotNumber ? `Lot ${property.lotNumber}` : ''}</p>
                            </div>
                            
                            <div className="ios-card p-4 mb-4">
                                <h3 className="font-semibold mb-3">Loan Summary</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between"><span className="text-gray-500">Sale Price:</span><span>{formatCurrency(property.salePrice)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Down Payment:</span><span>{formatCurrency(property.downPayment)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Amount Financed:</span><span>{formatCurrency(property.amountFinanced)}</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Interest Rate:</span><span>{((property.interestRate || 0) * 100).toFixed(1)}%</span></div>
                                    <div className="flex justify-between"><span className="text-gray-500">Term:</span><span>{property.termMonths} months</span></div>
                                </div>
                            </div>
                            
                            <div className="bg-blue-50 rounded-lg p-4 mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-semibold">Current Balance:</span>
                                    <span className="text-2xl font-bold text-blue-600">{formatCurrency(balance)}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span>Payments Made:</span>
                                    <span>{paymentsCount} of {property.termMonths}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span>Total Paid:</span>
                                    <span className="text-green-600">{formatCurrency(totalPaid)}</span>
                                </div>
                            </div>
                            
                            <div className="bg-green-50 rounded-lg p-4 mb-4">
                                <p className="text-sm text-gray-600">Next Payment Due:</p>
                                <p className="text-xl font-bold">{formatDate(nextDue)}</p>
                                <p className="text-lg font-semibold text-green-600">{formatCurrency(Math.min(property.monthlyPayment, balance))}</p>
                            </div>
                            
                            {payments.length > 0 && (
                                <div>
                                    <h3 className="font-semibold mb-2">Recent Payments</h3>
                                    <div className="text-sm space-y-2">
                                        {payments.slice(-5).reverse().map(pay => (
                                            <div key={pay.id} className="flex justify-between py-2 border-b border-gray-100">
                                                <span>{formatDate(pay.dateReceived)}</span>
                                                <span className="font-medium">{formatCurrency(pay.amountPaid)}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 border-t border-gray-200 no-print sticky bottom-0 bg-white">
                            <button className="ios-button ios-button-secondary flex items-center justify-center gap-2" onClick={handlePrint}>
                                <Icon name="printer" className="w-5 h-5" /> Print Statement
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== REPORTS ==============
        const Reports = ({ store }) => {
            const { properties, payments, getProfit, getBalance } = store;
            const [reportType, setReportType] = useState('profit');
            
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Profit by property
            const profitData = properties.filter(p => p.salePrice).map(p => ({
                name: p.buyer || p.address?.slice(0, 20) || 'Unknown',
                profit: getProfit(p)
            })).sort((a, b) => b.profit - a.profit);

            // Payments over time (last 6 months)
            const monthlyPayments = {};
            payments.forEach(p => {
                const month = new Date(p.dateReceived).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                monthlyPayments[month] = (monthlyPayments[month] || 0) + (p.amountPaid || 0);
            });

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    
                    if (reportType === 'profit' && profitData.length > 0) {
                        chartInstance.current = new Chart(chartRef.current, {
                            type: 'bar',
                            data: {
                                labels: profitData.map(d => d.name),
                                datasets: [{
                                    label: 'Profit',
                                    data: profitData.map(d => d.profit),
                                    backgroundColor: profitData.map(d => d.profit >= 0 ? '#34C759' : '#FF3B30')
                                }]
                            },
                            options: { responsive: true, plugins: { legend: { display: false } } }
                        });
                    } else if (reportType === 'payments' && Object.keys(monthlyPayments).length > 0) {
                        const labels = Object.keys(monthlyPayments).slice(-6);
                        chartInstance.current = new Chart(chartRef.current, {
                            type: 'line',
                            data: {
                                labels,
                                datasets: [{
                                    label: 'Payments Received',
                                    data: labels.map(l => monthlyPayments[l]),
                                    borderColor: '#007AFF',
                                    backgroundColor: 'rgba(0,122,255,0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: { responsive: true }
                        });
                    }
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [reportType, properties, payments]);

            const totalProfit = properties.filter(p => p.salePrice).reduce((sum, p) => sum + getProfit(p), 0);
            const totalOutstanding = properties.filter(p => p.status === 'Financed').reduce((sum, p) => sum + getBalance(p), 0);
            const totalCollected = payments.reduce((sum, p) => sum + (p.amountPaid || 0), 0);

            return (
                <div className="pb-24">
                    <Header title="Reports" />
                    <div className="p-4 space-y-4">
                        {/* Summary Cards */}
                        <div className="grid grid-cols-3 gap-3">
                            <div className="ios-card p-3 text-center">
                                <p className="text-xs text-gray-500">Total Profit</p>
                                <p className="text-lg font-bold text-green-500">{formatCurrency(totalProfit)}</p>
                            </div>
                            <div className="ios-card p-3 text-center">
                                <p className="text-xs text-gray-500">Outstanding</p>
                                <p className="text-lg font-bold text-orange-500">{formatCurrency(totalOutstanding)}</p>
                            </div>
                            <div className="ios-card p-3 text-center">
                                <p className="text-xs text-gray-500">Collected</p>
                                <p className="text-lg font-bold text-blue-500">{formatCurrency(totalCollected)}</p>
                            </div>
                        </div>

                        {/* Report Type Selector */}
                        <div className="ios-segment">
                            <button className={reportType === 'profit' ? 'active' : ''} onClick={() => setReportType('profit')}>Profit by Deal</button>
                            <button className={reportType === 'payments' ? 'active' : ''} onClick={() => setReportType('payments')}>Payments Trend</button>
                        </div>

                        {/* Chart */}
                        <div className="ios-card p-4">
                            <canvas ref={chartRef} height="200"></canvas>
                        </div>

                        {/* Profit Table */}
                        {reportType === 'profit' && (
                            <div className="ios-card">
                                <div className="p-4 border-b border-gray-100">
                                    <h3 className="font-semibold">Profit by Property</h3>
                                </div>
                                {profitData.length === 0 ? (
                                    <div className="p-8 text-center text-gray-500">No sold properties yet</div>
                                ) : profitData.map((d, i) => (
                                    <div key={i} className="flex justify-between p-4 border-b border-gray-100 last:border-0">
                                        <span>{d.name}</span>
                                        <span className={`font-semibold ${d.profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(d.profit)}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ============== MORE MENU ==============
        const More = ({ currentUser, store, onLogout }) => {
            const exportData = () => {
                const data = { properties: store.properties, payments: store.payments, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mh-backup-${today()}.json`;
                a.click();
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.properties) localStorage.setItem('mh_properties', JSON.stringify(data.properties));
                        if (data.payments) localStorage.setItem('mh_payments', JSON.stringify(data.payments));
                        window.location.reload();
                    } catch (err) { alert('Invalid file'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="pb-24">
                    <Header title="More" />
                    <div className="p-4 space-y-4">
                        <div className="ios-card p-4 flex items-center">
                            <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl">
                                {currentUser[0]}
                            </div>
                            <div className="ml-4">
                                <p className="font-semibold">{currentUser}</p>
                                <p className="text-sm text-gray-500">Logged in</p>
                            </div>
                        </div>

                        <div className="ios-card">
                            <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Data</h3></div>
                            <button className="w-full text-left p-4 border-b border-gray-100 flex items-center" onClick={exportData}>
                                <Icon name="download" className="w-5 h-5 mr-3 text-blue-500" />
                                <span>Export Backup</span>
                            </button>
                            <label className="w-full text-left p-4 flex items-center cursor-pointer">
                                <Icon name="download" className="w-5 h-5 mr-3 text-green-500 rotate-180" />
                                <span>Import Backup</span>
                                <input type="file" accept=".json" className="hidden" onChange={importData} />
                            </label>
                        </div>

                        <div className="ios-card p-4">
                            <h3 className="font-semibold mb-2">Florida Late Fee Rules</h3>
                            <p className="text-sm text-gray-600">Per F.S. ¬ß520.37:</p>
                            <ul className="text-sm text-gray-600 mt-2 space-y-1">
                                <li>‚Ä¢ Max late fee: 5% of installment</li>
                                <li>‚Ä¢ Grace period: 10 days minimum</li>
                                <li>‚Ä¢ One late fee per missed payment</li>
                            </ul>
                        </div>

                        <div className="ios-card">
                            <div className="p-4 border-b border-gray-100"><h3 className="font-semibold">Statistics</h3></div>
                            <div className="p-4 space-y-2 text-sm">
                                <div className="flex justify-between"><span className="text-gray-500">Properties</span><span>{store.properties.length}</span></div>
                                <div className="flex justify-between"><span className="text-gray-500">Payments</span><span>{store.payments.length}</span></div>
                            </div>
                        </div>

                        <button className="ios-button ios-button-danger" onClick={onLogout}>Sign Out</button>
                    </div>
                </div>
            );
        };

        // ============== MAIN APP ==============
        const App = () => {
            const [loggedIn, setLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState('');
            const [tab, setTab] = useState('dashboard');
            const [selectedProperty, setSelectedProperty] = useState(null);
            const [showPropertyForm, setShowPropertyForm] = useState(false);
            const [editProperty, setEditProperty] = useState(null);
            const [showPaymentForm, setShowPaymentForm] = useState(false);
            const [paymentForProperty, setPaymentForProperty] = useState(null);

            const store = useDataStore();

            useEffect(() => {
                const auth = localStorage.getItem('mh_auth');
                const user = localStorage.getItem('mh_user');
                if (auth && user) { setLoggedIn(true); setCurrentUser(user); }
            }, []);

            const handleLogin = (user) => { setLoggedIn(true); setCurrentUser(user); };
            const handleLogout = () => {
                localStorage.removeItem('mh_auth');
                localStorage.removeItem('mh_user');
                setLoggedIn(false);
                setCurrentUser('');
            };

            const handleSaveProperty = async (data) => {
                if (editProperty) {
                    await store.updateProperty(editProperty.id, data);
                } else {
                    await store.addProperty(data);
                }
                setShowPropertyForm(false);
                setEditProperty(null);
            };

            const handleSavePayment = async (data) => {
                await store.addPayment(data);
                setShowPaymentForm(false);
                setPaymentForProperty(null);
            };

            if (!loggedIn) return <Login onLogin={handleLogin} />;
            if (store.loading) return <div className="min-h-screen flex items-center justify-center"><div className="loading-spinner border-4 border-gray-200 border-t-blue-500 rounded-full w-8 h-8 animate-spin"></div></div>;

            return (
                <div className="min-h-screen bg-gray-100">
                    {tab === 'dashboard' && <Dashboard store={store} onViewProperty={p => setSelectedProperty(p)} />}
                    {tab === 'properties' && <PropertyList store={store} onView={p => setSelectedProperty(p)} onAdd={() => setShowPropertyForm(true)} />}
                    {tab === 'payments' && <PaymentList store={store} onAddPayment={() => setShowPaymentForm(true)} />}
                    {tab === 'reports' && <Reports store={store} />}
                    {tab === 'more' && <More currentUser={currentUser} store={store} onLogout={handleLogout} />}

                    <TabBar active={tab} onChange={setTab} />

                    {showPropertyForm && (
                        <PropertyForm property={editProperty} onSave={handleSaveProperty} onCancel={() => { setShowPropertyForm(false); setEditProperty(null); }} currentUser={currentUser} />
                    )}

                    {showPaymentForm && (
                        <PaymentForm property={paymentForProperty} properties={store.properties} store={store} onSave={handleSavePayment} onCancel={() => { setShowPaymentForm(false); setPaymentForProperty(null); }} currentUser={currentUser} />
                    )}

                    {selectedProperty && (
                        <PropertyDetail 
                            property={selectedProperty} 
                            store={store} 
                            onBack={() => setSelectedProperty(null)} 
                            onEdit={p => { setEditProperty(p); setShowPropertyForm(true); setSelectedProperty(null); }}
                            onAddPayment={() => { setPaymentForProperty(selectedProperty); setShowPaymentForm(true); }}
                            currentUser={currentUser}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
