<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mobile Home Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; font-size: 14px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .input { background: #f5f5f7; border: 1px solid #e5e5e5; border-radius: 6px; padding: 8px 12px; font-size: 13px; width: 100%; outline: none; }
        .input:focus { border-color: #007AFF; background: white; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .btn-primary { background: #007AFF; color: white; border: none; }
        .btn-primary:hover { background: #0066DD; }
        .btn-secondary { background: #e5e5e5; color: #333; border: none; }
        .btn-secondary:hover { background: #d5d5d5; }
        .btn-danger { background: #FF3B30; color: white; border: none; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 28px; }
        .sidebar { width: 200px; background: #1d1d1f; min-height: 100vh; }
        .sidebar-item { padding: 10px 16px; color: #999; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; transition: all 0.15s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar-item.active { background: rgba(0,122,255,0.2); color: #007AFF; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; border-radius: 10px; max-width: 500px; width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-lg { max-width: 700px; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid #e5e5e5; display: flex; justify-content: flex-end; gap: 8px; flex-shrink: 0; }
        .close-btn { width: 28px; height: 28px; border-radius: 50%; background: #e5e5e5; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { background: #d5d5d5; }
        .table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .table th { text-align: left; padding: 8px 12px; background: #f9f9f9; font-weight: 500; color: #666; border-bottom: 1px solid #e5e5e5; }
        .table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .table tr:hover { background: #f9f9f9; }
        .table tr { cursor: pointer; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .badge-gray { background: #e5e5e5; color: #666; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .stat-card { padding: 12px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: 600; }
        .stat-label { font-size: 11px; color: #666; margin-top: 2px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .text-green { color: #059669; }
        .text-red { color: #dc2626; }
        .text-blue { color: #2563eb; }
        .text-orange { color: #d97706; }
        @media print { .no-print { display: none !important; } body { background: white; } }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex !important; }
            .main-content { margin-left: 0 !important; }
            .content-area { margin-left: 0 !important; }
        }
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e5e5; z-index: 50; }
        .mobile-nav button { flex: 1; padding: 8px; text-align: center; font-size: 11px; color: #666; background: none; border: none; cursor: pointer; }
        .mobile-nav button.active { color: #007AFF; }
        .content-area { margin-left: 200px; }
        .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
        .search-input { max-width: 250px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============== CONFIG ==============
        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        const APP_PASSWORD = 'loan2024';
        const USERS = ['Ric', 'Vir', 'Derrick'];
        const LATE_FEE_PERCENT = 0.05;
        const GRACE_PERIOD_DAYS = 10;

        // ============== UTILS ==============
        const fmt = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0);
        const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî';
        const today = () => new Date().toISOString().split('T')[0];
        const calcPayment = (p, r, m) => { if (!p || !m) return 0; if (r === 0) return p / m; const mr = r / 12; return p * (mr * Math.pow(1 + mr, m)) / (Math.pow(1 + mr, m) - 1); };

        // ============== ICONS ==============
        const Icon = ({ name, size = 18 }) => {
            const icons = {
                home: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
                building: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>,
                dollar: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
                chart: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
                settings: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
                plus: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
                x: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
                search: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
                printer: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>,
                edit: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
                download: <svg width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
            };
            return icons[name] || null;
        };

        // ============== INITIAL DATA ==============
        const INITIAL_PROPERTIES = [
            { id: '1', address: '6018 Black Dairy Road, Seffner FL 33584', lotNumber: '2', parkName: 'Oak Trail', year: '1973', makeModel: 'APAC HS', vinSerial: 'F3651289', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 4840.75, holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash', salePrice: 8000, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: 'Romina', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '2', address: '11416 E US HWY 92, Seffner FL 33584', lotNumber: '23', parkName: 'Family Rental', year: '', makeModel: 'Mark HS', vinSerial: '126', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Kenyon Weiss', purchasePrice: 9250.50, holdingCosts: 0, renovationCosts: 0, status: 'Inventory', salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '3', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'B1', parkName: 'Twin Palms', year: '', makeModel: '', vinSerial: '', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 0, holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash', salePrice: 17000, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: 'Lola', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '4', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'B10', parkName: 'Twin Palms', year: '1970', makeModel: 'LBRT HS', vinSerial: 'G4084', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 9080.75, holdingCosts: 0, renovationCosts: 0, status: 'Sold-Cash', salePrice: 18900, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: 'Henil', contractDate: '', firstPaymentDue: '', notes: 'Profit $11,000 after interest', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '5', address: '11416 E US HWY 92, Seffner FL 33584', lotNumber: '11', parkName: 'Family Rental', year: '', makeModel: '', vinSerial: '', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Virginia Lee', purchasePrice: 0, holdingCosts: 0, renovationCosts: 0, status: 'Inventory', salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '6', address: '12091 Emory Oak Loop, Thonotosassa FL', lotNumber: 'P13', parkName: 'Green Oaks', year: '1980', makeModel: 'Noma', vinSerial: '', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50, holdingCosts: 150, renovationCosts: 0, status: 'Sold-Cash', salePrice: 9500, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '7', address: '12010 Emory Oak Loop, Thonotosassa FL', lotNumber: '2P', parkName: 'Green Oaks', year: '', makeModel: '', vinSerial: '', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50, holdingCosts: 150, renovationCosts: 5892.42, status: 'Sold-Cash', salePrice: 16000, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: 'Michelle', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '8', address: '12003 Emory Oak Loop, Thonotosassa FL', lotNumber: '1A', parkName: 'Green Oaks', year: '', makeModel: '', vinSerial: '', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Doreen Kruger', purchasePrice: 3422.50, holdingCosts: 150, renovationCosts: 0, status: 'Inventory', salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '9', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'A1', parkName: 'Twin Palms', year: '', makeModel: 'Amer', vinSerial: '33730', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Sean Clark', purchasePrice: 3390.63, holdingCosts: 0, renovationCosts: 0, status: 'Inventory', salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() },
            { id: '10', address: '11520 E US HWY 92, Seffner FL 33584', lotNumber: 'A3', parkName: 'Twin Palms', year: '', makeModel: 'Kent', vinSerial: 'K5520', titleNumber: '', seller: 'Specialville Estates', purchaser: 'Sean Clark', purchasePrice: 2315.63, holdingCosts: 0, renovationCosts: 0, status: 'Inventory', salePrice: 0, downPayment: 0, interestRate: 0, termMonths: 0, amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: '', firstPaymentDue: '', notes: '', enteredBy: 'Ric', createdAt: new Date().toISOString() }
        ];

        // ============== DATA STORE ==============
        const useDataStore = () => {
            const [properties, setProperties] = useState([]);
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const saved = localStorage.getItem('mh_properties_v2');
                const savedPay = localStorage.getItem('mh_payments_v2');
                if (saved) { setProperties(JSON.parse(saved)); } 
                else { setProperties(INITIAL_PROPERTIES); localStorage.setItem('mh_properties_v2', JSON.stringify(INITIAL_PROPERTIES)); }
                if (savedPay) setPayments(JSON.parse(savedPay));
                setLoading(false);
            }, []);

            useEffect(() => {
                if (!loading) {
                    localStorage.setItem('mh_properties_v2', JSON.stringify(properties));
                    localStorage.setItem('mh_payments_v2', JSON.stringify(payments));
                }
            }, [properties, payments, loading]);

            const addProperty = (p) => { const np = { ...p, id: Date.now().toString(), createdAt: new Date().toISOString() }; setProperties(prev => [...prev, np]); return np; };
            const updateProperty = (id, u) => setProperties(prev => prev.map(p => p.id === id ? { ...p, ...u } : p));
            const deleteProperty = (id) => setProperties(prev => prev.filter(p => p.id !== id));
            const addPayment = (p) => { const np = { ...p, id: Date.now().toString(), createdAt: new Date().toISOString() }; setPayments(prev => [...prev, np]); return np; };
            const getPropertyPayments = (id) => payments.filter(p => p.propertyId === id).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            const getBalance = (p) => { if (!p.amountFinanced) return 0; const pp = getPropertyPayments(p.id); return Math.max(0, p.amountFinanced - pp.reduce((s, x) => s + (parseFloat(x.principal) || 0), 0)); };
            const getTotalPaid = (p) => getPropertyPayments(p.id).reduce((s, x) => s + (parseFloat(x.amountPaid) || 0), 0);
            const getProfit = (p) => (parseFloat(p.salePrice) || 0) - (parseFloat(p.purchasePrice) || 0) - (parseFloat(p.holdingCosts) || 0) - (parseFloat(p.renovationCosts) || 0);

            return { properties, payments, loading, addProperty, updateProperty, deleteProperty, addPayment, getPropertyPayments, getBalance, getTotalPaid, getProfit };
        };

        // ============== MODAL ==============
        const Modal = ({ title, children, onClose, size = '', footer }) => (
            <div className="modal-backdrop" onClick={onClose}>
                <div className={`modal ${size === 'lg' ? 'modal-lg' : ''}`} onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="font-semibold">{title}</h3>
                        <button className="close-btn" onClick={onClose}><Icon name="x" size={16} /></button>
                    </div>
                    <div className="modal-body">{children}</div>
                    {footer && <div className="modal-footer">{footer}</div>}
                </div>
            </div>
        );

        // ============== LOGIN ==============
        const Login = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const handleLogin = () => {
                if (pass === APP_PASSWORD && user) { localStorage.setItem('mh_user', user); localStorage.setItem('mh_auth', 'true'); onLogin(user); }
                else { setError('Invalid credentials'); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-600 p-4">
                    <div className="card p-6 w-full max-w-xs">
                        <div className="text-center mb-6">
                            <div className="text-4xl mb-2">üè†</div>
                            <h1 className="text-lg font-bold">Mobile Home Manager</h1>
                        </div>
                        <div className="space-y-3">
                            <select className="input" value={user} onChange={e => setUser(e.target.value)}>
                                <option value="">Select user...</option>
                                {USERS.map(u => <option key={u} value={u}>{u}</option>)}
                            </select>
                            <input type="password" className="input" placeholder="Password" value={pass} onChange={e => setPass(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleLogin()} />
                            {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                            <button className="btn btn-primary w-full" onClick={handleLogin}>Sign In</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== DASHBOARD ==============
        const Dashboard = ({ store }) => {
            const { properties, payments, getBalance, getProfit } = store;
            const inventory = properties.filter(p => p.status === 'Inventory').length;
            const financed = properties.filter(p => p.status === 'Financed').length;
            const sold = properties.filter(p => ['Sold-Cash', 'Paid Off'].includes(p.status)).length;
            const totalProfit = properties.filter(p => p.salePrice).reduce((s, p) => s + getProfit(p), 0);
            const totalOutstanding = properties.filter(p => p.status === 'Financed').reduce((s, p) => s + getBalance(p), 0);
            const totalCollected = payments.reduce((s, p) => s + (parseFloat(p.amountPaid) || 0), 0);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && properties.length > 0) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'doughnut',
                        data: { labels: ['Inventory', 'Financed', 'Sold'], datasets: [{ data: [inventory, financed, sold], backgroundColor: ['#9ca3af', '#3b82f6', '#22c55e'] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } } } }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [properties]);

            return (
                <div>
                    <h2 className="text-lg font-semibold mb-3">Dashboard</h2>
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                        <div className="card stat-card"><div className="stat-value">{properties.length}</div><div className="stat-label">Total Properties</div></div>
                        <div className="card stat-card"><div className="stat-value text-blue">{financed}</div><div className="stat-label">Active Financing</div></div>
                        <div className="card stat-card"><div className="stat-value text-orange">{fmt(totalOutstanding)}</div><div className="stat-label">Outstanding</div></div>
                        <div className="card stat-card"><div className="stat-value text-green">{fmt(totalProfit)}</div><div className="stat-label">Total Profit</div></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-3">Status Distribution</h3>
                            <div style={{ height: '180px' }}><canvas ref={chartRef}></canvas></div>
                        </div>
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-3">Financial Summary</h3>
                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between"><span className="text-gray-500">Total Invested</span><span className="font-medium">{fmt(properties.reduce((s, p) => s + (p.purchasePrice || 0) + (p.renovationCosts || 0) + (p.holdingCosts || 0), 0))}</span></div>
                                <div className="flex justify-between"><span className="text-gray-500">Total Sales</span><span className="font-medium">{fmt(properties.reduce((s, p) => s + (p.salePrice || 0), 0))}</span></div>
                                <div className="flex justify-between"><span className="text-gray-500">Payments Collected</span><span className="font-medium text-green">{fmt(totalCollected)}</span></div>
                                <div className="flex justify-between border-t pt-2 mt-2"><span className="text-gray-500">Net Profit</span><span className="font-semibold text-green">{fmt(totalProfit)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== PROPERTIES ==============
        const Properties = ({ store, currentUser }) => {
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            const [selected, setSelected] = useState(null);
            const [showForm, setShowForm] = useState(false);
            const [editProp, setEditProp] = useState(null);

            const filtered = store.properties.filter(p => {
                const match = (p.address || '').toLowerCase().includes(search.toLowerCase()) || (p.buyer || '').toLowerCase().includes(search.toLowerCase()) || (p.parkName || '').toLowerCase().includes(search.toLowerCase());
                const fMatch = filter === 'all' || p.status === filter;
                return match && fMatch;
            });

            const getBadgeClass = (s) => ({ 'Inventory': 'badge-gray', 'Listed': 'badge-yellow', 'Sold-Cash': 'badge-green', 'Financed': 'badge-blue', 'Paid Off': 'badge-purple', 'Repo': 'badge-red' }[s] || 'badge-gray');

            return (
                <div>
                    <div className="flex justify-between items-center mb-3">
                        <h2 className="text-lg font-semibold">Properties</h2>
                        <button className="btn btn-primary btn-sm flex items-center gap-1" onClick={() => { setEditProp(null); setShowForm(true); }}><Icon name="plus" size={14} /> Add</button>
                    </div>
                    <div className="action-bar">
                        <div className="relative search-input flex-1">
                            <Icon name="search" size={14} />
                            <input className="input pl-8" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} style={{ paddingLeft: '32px' }} />
                        </div>
                        <select className="input" style={{ width: 'auto' }} value={filter} onChange={e => setFilter(e.target.value)}>
                            <option value="all">All Status</option>
                            <option value="Inventory">Inventory</option>
                            <option value="Listed">Listed</option>
                            <option value="Financed">Financed</option>
                            <option value="Sold-Cash">Sold-Cash</option>
                            <option value="Paid Off">Paid Off</option>
                            <option value="Repo">Repo</option>
                        </select>
                    </div>
                    <div className="card overflow-hidden">
                        <table className="table">
                            <thead>
                                <tr><th>Address</th><th>Park/Lot</th><th>Buyer</th><th>Purchase</th><th>Sale</th><th>Profit</th><th>Status</th></tr>
                            </thead>
                            <tbody>
                                {filtered.map(p => (
                                    <tr key={p.id} onClick={() => setSelected(p)}>
                                        <td className="font-medium">{p.address}</td>
                                        <td>{p.parkName} {p.lotNumber && `#${p.lotNumber}`}</td>
                                        <td>{p.buyer || '‚Äî'}</td>
                                        <td>{fmt(p.purchasePrice)}</td>
                                        <td>{p.salePrice ? fmt(p.salePrice) : '‚Äî'}</td>
                                        <td className={store.getProfit(p) >= 0 ? 'text-green' : 'text-red'}>{p.salePrice ? fmt(store.getProfit(p)) : '‚Äî'}</td>
                                        <td><span className={`badge ${getBadgeClass(p.status)}`}>{p.status}</span></td>
                                    </tr>
                                ))}
                                {filtered.length === 0 && <tr><td colSpan="7" className="text-center text-gray-500 py-8">No properties found</td></tr>}
                            </tbody>
                        </table>
                    </div>

                    {selected && <PropertyDetail property={selected} store={store} onClose={() => setSelected(null)} onEdit={() => { setEditProp(selected); setShowForm(true); setSelected(null); }} currentUser={currentUser} />}
                    {showForm && <PropertyForm property={editProp} store={store} onClose={() => { setShowForm(false); setEditProp(null); }} currentUser={currentUser} />}
                </div>
            );
        };

        // ============== PROPERTY DETAIL ==============
        const PropertyDetail = ({ property: p, store, onClose, onEdit, currentUser }) => {
            const [showPaymentForm, setShowPaymentForm] = useState(false);
            const [showReceipt, setShowReceipt] = useState(null);
            const [showStatement, setShowStatement] = useState(false);
            const payments = store.getPropertyPayments(p.id);
            const balance = store.getBalance(p);
            const profit = store.getProfit(p);

            return (
                <>
                    <Modal title="Property Details" onClose={onClose} size="lg" footer={
                        <div className="flex gap-2 w-full">
                            <button className="btn btn-secondary flex-1" onClick={onEdit}><Icon name="edit" size={14} /> Edit</button>
                            {p.status === 'Financed' && <button className="btn btn-primary flex-1" onClick={() => setShowPaymentForm(true)}><Icon name="dollar" size={14} /> Add Payment</button>}
                        </div>
                    }>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <h4 className="font-medium text-gray-500 text-xs uppercase mb-2">Property</h4>
                                <div className="space-y-1">
                                    <div><span className="text-gray-500">Address:</span> <span className="font-medium">{p.address}</span></div>
                                    <div><span className="text-gray-500">Park/Lot:</span> {p.parkName} {p.lotNumber && `#${p.lotNumber}`}</div>
                                    <div><span className="text-gray-500">Year:</span> {p.year || '‚Äî'}</div>
                                    <div><span className="text-gray-500">Make/Model:</span> {p.makeModel || '‚Äî'}</div>
                                    <div><span className="text-gray-500">VIN:</span> {p.vinSerial || '‚Äî'}</div>
                                </div>
                            </div>
                            <div>
                                <h4 className="font-medium text-gray-500 text-xs uppercase mb-2">Purchase</h4>
                                <div className="space-y-1">
                                    <div><span className="text-gray-500">Seller:</span> {p.seller || '‚Äî'}</div>
                                    <div><span className="text-gray-500">Purchaser:</span> {p.purchaser || '‚Äî'}</div>
                                    <div><span className="text-gray-500">Purchase Price:</span> {fmt(p.purchasePrice)}</div>
                                    <div><span className="text-gray-500">Holding:</span> {fmt(p.holdingCosts)}</div>
                                    <div><span className="text-gray-500">Renovation:</span> {fmt(p.renovationCosts)}</div>
                                </div>
                            </div>
                            {p.salePrice > 0 && (
                                <div>
                                    <h4 className="font-medium text-gray-500 text-xs uppercase mb-2">Sale</h4>
                                    <div className="space-y-1">
                                        <div><span className="text-gray-500">Buyer:</span> {p.buyer || '‚Äî'}</div>
                                        <div><span className="text-gray-500">Sale Price:</span> {fmt(p.salePrice)}</div>
                                        <div><span className="text-gray-500">Down Payment:</span> {fmt(p.downPayment)}</div>
                                        <div className="font-semibold"><span className="text-gray-500">Profit:</span> <span className={profit >= 0 ? 'text-green' : 'text-red'}>{fmt(profit)}</span></div>
                                    </div>
                                </div>
                            )}
                            {p.status === 'Financed' && (
                                <div>
                                    <h4 className="font-medium text-gray-500 text-xs uppercase mb-2">Financing</h4>
                                    <div className="space-y-1">
                                        <div><span className="text-gray-500">Amount Financed:</span> {fmt(p.amountFinanced)}</div>
                                        <div><span className="text-gray-500">Rate:</span> {((p.interestRate || 0) * 100).toFixed(1)}%</div>
                                        <div><span className="text-gray-500">Term:</span> {p.termMonths} mo</div>
                                        <div><span className="text-gray-500">Monthly:</span> <span className="font-medium text-blue">{fmt(p.monthlyPayment)}</span></div>
                                        <div><span className="text-gray-500">Balance:</span> <span className="font-semibold">{fmt(balance)}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {p.status === 'Financed' && (
                            <div className="mt-4 pt-4 border-t">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-medium text-sm">Payment History</h4>
                                    <div className="flex gap-2">
                                        <button className="btn btn-secondary btn-sm" onClick={() => setShowStatement(true)}><Icon name="printer" size={12} /> Statement</button>
                                    </div>
                                </div>
                                {payments.length === 0 ? (
                                    <p className="text-gray-500 text-sm">No payments yet</p>
                                ) : (
                                    <table className="table">
                                        <thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Status</th><th></th></tr></thead>
                                        <tbody>
                                            {payments.map(pay => (
                                                <tr key={pay.id} onClick={() => setShowReceipt(pay)}>
                                                    <td>{fmtDate(pay.dateReceived)}</td>
                                                    <td>{fmt(pay.amountPaid)}</td>
                                                    <td>{pay.paymentMethod}</td>
                                                    <td className={pay.daysLate > 0 ? 'text-orange' : 'text-green'}>{pay.daysLate > 0 ? `${pay.daysLate}d late` : 'On time'}</td>
                                                    <td><button className="btn btn-secondary btn-sm">Receipt</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                    </Modal>

                    {showPaymentForm && <PaymentForm property={p} store={store} onClose={() => setShowPaymentForm(false)} currentUser={currentUser} />}
                    {showReceipt && <Receipt payment={showReceipt} property={p} onClose={() => setShowReceipt(null)} />}
                    {showStatement && <Statement property={p} payments={payments} balance={balance} onClose={() => setShowStatement(false)} />}
                </>
            );
        };

        // ============== PROPERTY FORM ==============
        const PropertyForm = ({ property, store, onClose, currentUser }) => {
            const [form, setForm] = useState(property || {
                address: '', lotNumber: '', parkName: '', year: '', makeModel: '', vinSerial: '', titleNumber: '',
                seller: '', purchaser: '', purchasePrice: '', holdingCosts: '', renovationCosts: '',
                status: 'Inventory', salePrice: '', downPayment: '', interestRate: '0', termMonths: '',
                amountFinanced: 0, monthlyPayment: 0, buyer: '', contractDate: today(), firstPaymentDue: '', notes: '', enteredBy: currentUser
            });
            const h = (f, v) => setForm(p => ({ ...p, [f]: v }));
            const save = () => {
                const af = (parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0);
                const mp = form.status === 'Financed' ? calcPayment(af, parseFloat(form.interestRate || 0) / 100, parseInt(form.termMonths || 1)) : 0;
                const data = { ...form, purchasePrice: parseFloat(form.purchasePrice) || 0, holdingCosts: parseFloat(form.holdingCosts) || 0, renovationCosts: parseFloat(form.renovationCosts) || 0, salePrice: parseFloat(form.salePrice) || 0, downPayment: parseFloat(form.downPayment) || 0, interestRate: parseFloat(form.interestRate || 0) / 100, termMonths: parseInt(form.termMonths) || 0, amountFinanced: af, monthlyPayment: mp };
                if (property) { store.updateProperty(property.id, data); } else { store.addProperty(data); }
                onClose();
            };

            return (
                <Modal title={property ? 'Edit Property' : 'Add Property'} onClose={onClose} size="lg" footer={
                    <><button className="btn btn-secondary" onClick={onClose}>Cancel</button><button className="btn btn-primary" onClick={save}>Save</button></>
                }>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                        <div className="col-span-2 form-group"><label className="form-label">Address *</label><input className="input" value={form.address} onChange={e => h('address', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Park Name</label><input className="input" value={form.parkName} onChange={e => h('parkName', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Lot #</label><input className="input" value={form.lotNumber} onChange={e => h('lotNumber', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Year</label><input className="input" value={form.year} onChange={e => h('year', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Make/Model</label><input className="input" value={form.makeModel} onChange={e => h('makeModel', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">VIN/Serial</label><input className="input" value={form.vinSerial} onChange={e => h('vinSerial', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Title #</label><input className="input" value={form.titleNumber} onChange={e => h('titleNumber', e.target.value)} /></div>
                        
                        <div className="col-span-2 border-t my-2 pt-2"><span className="text-xs font-medium text-gray-500">PURCHASE INFO</span></div>
                        <div className="form-group"><label className="form-label">Seller</label><input className="input" value={form.seller} onChange={e => h('seller', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Purchaser</label><input className="input" value={form.purchaser} onChange={e => h('purchaser', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Purchase Price</label><input className="input" type="number" step="0.01" value={form.purchasePrice} onChange={e => h('purchasePrice', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Holding Costs</label><input className="input" type="number" step="0.01" value={form.holdingCosts} onChange={e => h('holdingCosts', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Renovation Costs</label><input className="input" type="number" step="0.01" value={form.renovationCosts} onChange={e => h('renovationCosts', e.target.value)} /></div>
                        <div className="form-group"><label className="form-label">Status</label><select className="input" value={form.status} onChange={e => h('status', e.target.value)}><option value="Inventory">Inventory</option><option value="Listed">Listed</option><option value="Sold-Cash">Sold - Cash</option><option value="Financed">Financed</option><option value="Paid Off">Paid Off</option><option value="Repo">Repo</option></select></div>

                        {['Sold-Cash', 'Financed', 'Paid Off'].includes(form.status) && (
                            <>
                                <div className="col-span-2 border-t my-2 pt-2"><span className="text-xs font-medium text-gray-500">SALE INFO</span></div>
                                <div className="form-group"><label className="form-label">Buyer Name</label><input className="input" value={form.buyer} onChange={e => h('buyer', e.target.value)} /></div>
                                <div className="form-group"><label className="form-label">Sale Price</label><input className="input" type="number" step="0.01" value={form.salePrice} onChange={e => h('salePrice', e.target.value)} /></div>
                                <div className="form-group"><label className="form-label">Down Payment</label><input className="input" type="number" step="0.01" value={form.downPayment} onChange={e => h('downPayment', e.target.value)} /></div>
                            </>
                        )}

                        {form.status === 'Financed' && (
                            <>
                                <div className="col-span-2 border-t my-2 pt-2"><span className="text-xs font-medium text-gray-500">FINANCING</span></div>
                                <div className="form-group"><label className="form-label">Interest Rate (%)</label><input className="input" type="number" step="0.1" value={form.interestRate} onChange={e => h('interestRate', e.target.value)} /></div>
                                <div className="form-group"><label className="form-label">Term (Months)</label><input className="input" type="number" value={form.termMonths} onChange={e => h('termMonths', e.target.value)} /></div>
                                <div className="form-group"><label className="form-label">Contract Date</label><input className="input" type="date" value={form.contractDate} onChange={e => h('contractDate', e.target.value)} /></div>
                                <div className="form-group"><label className="form-label">First Payment Due</label><input className="input" type="date" value={form.firstPaymentDue} onChange={e => h('firstPaymentDue', e.target.value)} /></div>
                                {form.salePrice && form.termMonths && (
                                    <div className="col-span-2 bg-blue-50 p-3 rounded text-sm">
                                        <div className="flex justify-between"><span>Amount Financed:</span><span className="font-medium">{fmt((parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0))}</span></div>
                                        <div className="flex justify-between"><span>Monthly Payment:</span><span className="font-bold text-blue">{fmt(calcPayment((parseFloat(form.salePrice) || 0) - (parseFloat(form.downPayment) || 0), parseFloat(form.interestRate || 0) / 100, parseInt(form.termMonths || 1)))}</span></div>
                                    </div>
                                )}
                            </>
                        )}

                        <div className="col-span-2 form-group"><label className="form-label">Notes</label><textarea className="input" rows="2" value={form.notes} onChange={e => h('notes', e.target.value)} /></div>
                    </div>
                </Modal>
            );
        };

        // ============== PAYMENTS ==============
        const Payments = ({ store, currentUser }) => {
            const [search, setSearch] = useState('');
            const [showForm, setShowForm] = useState(false);
            const sorted = [...store.payments].sort((a, b) => new Date(b.dateReceived) - new Date(a.dateReceived));
            const filtered = sorted.filter(p => (p.buyerName || '').toLowerCase().includes(search.toLowerCase()));

            return (
                <div>
                    <div className="flex justify-between items-center mb-3">
                        <h2 className="text-lg font-semibold">Payments</h2>
                        <button className="btn btn-primary btn-sm flex items-center gap-1" onClick={() => setShowForm(true)}><Icon name="plus" size={14} /> Add Payment</button>
                    </div>
                    <div className="action-bar">
                        <div className="relative search-input">
                            <input className="input pl-8" placeholder="Search by buyer..." value={search} onChange={e => setSearch(e.target.value)} style={{ paddingLeft: '32px' }} />
                        </div>
                    </div>
                    <div className="card overflow-hidden">
                        <table className="table">
                            <thead><tr><th>Date</th><th>Buyer</th><th>Amount</th><th>Method</th><th>Principal</th><th>Interest</th><th>Late Fee</th><th>By</th></tr></thead>
                            <tbody>
                                {filtered.map(p => (
                                    <tr key={p.id}>
                                        <td>{fmtDate(p.dateReceived)}</td>
                                        <td className="font-medium">{p.buyerName || '‚Äî'}</td>
                                        <td className="font-medium">{fmt(p.amountPaid)}</td>
                                        <td>{p.paymentMethod}</td>
                                        <td>{fmt(p.principal)}</td>
                                        <td>{fmt(p.interest)}</td>
                                        <td className={p.lateFee > 0 ? 'text-orange' : ''}>{fmt(p.lateFee)}</td>
                                        <td>{p.enteredBy}</td>
                                    </tr>
                                ))}
                                {filtered.length === 0 && <tr><td colSpan="8" className="text-center text-gray-500 py-8">No payments found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showForm && <PaymentForm store={store} onClose={() => setShowForm(false)} currentUser={currentUser} />}
                </div>
            );
        };

        // ============== PAYMENT FORM ==============
        const PaymentForm = ({ property, store, onClose, currentUser }) => {
            const [selectedId, setSelectedId] = useState(property?.id || '');
            const selected = property || store.properties.find(p => p.id === selectedId);
            const [form, setForm] = useState({ dueDate: today(), dateReceived: today(), amountPaid: selected?.monthlyPayment?.toFixed(2) || '', paymentMethod: 'Zelle', notes: '', enteredBy: currentUser });

            useEffect(() => { if (selected) setForm(f => ({ ...f, amountPaid: selected.monthlyPayment?.toFixed(2) || '' })); }, [selectedId]);

            const financedProps = store.properties.filter(p => p.status === 'Financed');

            const save = () => {
                if (!selected) return;
                const bal = store.getBalance(selected);
                const late = Math.max(0, Math.floor((new Date(form.dateReceived) - new Date(form.dueDate)) / 86400000));
                const fee = late > GRACE_PERIOD_DAYS ? Math.min(selected.monthlyPayment * LATE_FEE_PERCENT, selected.monthlyPayment) : 0;
                const int = selected.interestRate > 0 ? bal * (selected.interestRate / 12) : 0;
                const prin = Math.max(0, parseFloat(form.amountPaid) - int - fee);
                store.addPayment({ ...form, propertyId: selected.id, buyerName: selected.buyer, amountPaid: parseFloat(form.amountPaid), interest: int, principal: prin, lateFee: fee, daysLate: late, beginningBalance: bal, endingBalance: Math.max(0, bal - prin) });
                onClose();
            };

            return (
                <Modal title="Log Payment" onClose={onClose} footer={
                    <><button className="btn btn-secondary" onClick={onClose}>Cancel</button><button className="btn btn-primary" onClick={save} disabled={!selected}>Save</button></>
                }>
                    {!property && (
                        <div className="form-group">
                            <label className="form-label">Select Property *</label>
                            <select className="input" value={selectedId} onChange={e => setSelectedId(e.target.value)}>
                                <option value="">Choose...</option>
                                {financedProps.map(p => <option key={p.id} value={p.id}>{p.buyer} - {p.address}</option>)}
                            </select>
                            {financedProps.length === 0 && <p className="text-orange text-xs mt-1">No financed properties. Change a property status to "Financed" first.</p>}
                        </div>
                    )}
                    {selected && (
                        <>
                            <div className="bg-gray-50 p-3 rounded mb-3 text-sm">
                                <div className="font-medium">{selected.buyer}</div>
                                <div className="text-gray-500 text-xs">{selected.address}</div>
                                <div className="flex justify-between mt-2"><span>Balance:</span><span className="font-medium">{fmt(store.getBalance(selected))}</span></div>
                                <div className="flex justify-between"><span>Monthly:</span><span className="font-medium text-blue">{fmt(selected.monthlyPayment)}</span></div>
                            </div>
                            <div className="form-row">
                                <div className="form-group"><label className="form-label">Due Date</label><input className="input" type="date" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} /></div>
                                <div className="form-group"><label className="form-label">Date Received</label><input className="input" type="date" value={form.dateReceived} onChange={e => setForm({ ...form, dateReceived: e.target.value })} /></div>
                            </div>
                            <div className="form-row">
                                <div className="form-group"><label className="form-label">Amount</label><input className="input" type="number" step="0.01" value={form.amountPaid} onChange={e => setForm({ ...form, amountPaid: e.target.value })} /></div>
                                <div className="form-group"><label className="form-label">Method</label><select className="input" value={form.paymentMethod} onChange={e => setForm({ ...form, paymentMethod: e.target.value })}>{['Cash', 'Zelle', 'Check', 'Money Order', 'Venmo', 'CashApp', 'Bank Transfer', 'Other'].map(m => <option key={m}>{m}</option>)}</select></div>
                            </div>
                            <div className="form-group"><label className="form-label">Notes</label><input className="input" value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} /></div>
                        </>
                    )}
                </Modal>
            );
        };

        // ============== RECEIPT ==============
        const Receipt = ({ payment: p, property: prop, onClose }) => (
            <Modal title="Payment Receipt" onClose={onClose} footer={<button className="btn btn-secondary" onClick={() => window.print()}><Icon name="printer" size={14} /> Print</button>}>
                <div className="text-center mb-4">
                    <h2 className="text-lg font-bold">PAYMENT RECEIPT</h2>
                    <p className="text-xs text-gray-500">Specialville Estates</p>
                </div>
                <div className="text-sm space-y-3">
                    <div className="flex justify-between border-b pb-2"><span className="text-gray-500">Date:</span><span>{fmtDate(p.dateReceived)}</span></div>
                    <div className="flex justify-between border-b pb-2"><span className="text-gray-500">Receipt #:</span><span>{p.id?.slice(-8).toUpperCase()}</span></div>
                    <div className="border-b pb-2"><div className="text-gray-500 text-xs">Received From:</div><div className="font-medium">{prop.buyer}</div><div className="text-xs text-gray-500">{prop.address}</div></div>
                    <div className="bg-gray-50 p-3 rounded">
                        <div className="flex justify-between"><span>Principal:</span><span>{fmt(p.principal)}</span></div>
                        <div className="flex justify-between"><span>Interest:</span><span>{fmt(p.interest)}</span></div>
                        {p.lateFee > 0 && <div className="flex justify-between text-orange"><span>Late Fee:</span><span>{fmt(p.lateFee)}</span></div>}
                        <div className="flex justify-between font-bold border-t mt-2 pt-2"><span>Total Paid:</span><span className="text-green">{fmt(p.amountPaid)}</span></div>
                    </div>
                    <div className="text-center text-xs text-gray-500">Remaining Balance: {fmt(p.endingBalance)}</div>
                </div>
            </Modal>
        );

        // ============== STATEMENT ==============
        const Statement = ({ property: p, payments, balance, onClose }) => (
            <Modal title="Monthly Statement" onClose={onClose} footer={<button className="btn btn-secondary" onClick={() => window.print()}><Icon name="printer" size={14} /> Print</button>}>
                <div className="text-center mb-4">
                    <h2 className="text-lg font-bold">MONTHLY STATEMENT</h2>
                    <p className="text-xs text-gray-500">Specialville Estates ‚Ä¢ {fmtDate(new Date())}</p>
                </div>
                <div className="text-sm">
                    <div className="mb-3"><div className="text-xs text-gray-500">Account Holder:</div><div className="font-medium">{p.buyer}</div><div className="text-xs text-gray-500">{p.address}</div></div>
                    <div className="bg-gray-50 p-3 rounded mb-3">
                        <div className="flex justify-between"><span>Sale Price:</span><span>{fmt(p.salePrice)}</span></div>
                        <div className="flex justify-between"><span>Down Payment:</span><span>{fmt(p.downPayment)}</span></div>
                        <div className="flex justify-between"><span>Amount Financed:</span><span>{fmt(p.amountFinanced)}</span></div>
                        <div className="flex justify-between"><span>Interest Rate:</span><span>{((p.interestRate || 0) * 100).toFixed(1)}%</span></div>
                    </div>
                    <div className="bg-blue-50 p-3 rounded mb-3">
                        <div className="flex justify-between font-bold"><span>Current Balance:</span><span className="text-blue">{fmt(balance)}</span></div>
                        <div className="flex justify-between text-xs"><span>Payments Made:</span><span>{payments.length} of {p.termMonths}</span></div>
                    </div>
                    <div className="bg-green-50 p-3 rounded">
                        <div className="text-xs text-gray-500">Monthly Payment Due:</div>
                        <div className="text-xl font-bold text-green">{fmt(Math.min(p.monthlyPayment, balance))}</div>
                    </div>
                </div>
            </Modal>
        );

        // ============== REPORTS ==============
        const Reports = ({ store }) => {
            const { properties, payments, getProfit, getBalance } = store;
            const profitData = properties.filter(p => p.salePrice).map(p => ({ name: p.buyer || p.lotNumber || 'Unknown', profit: getProfit(p) })).sort((a, b) => b.profit - a.profit);
            const totalProfit = profitData.reduce((s, d) => s + d.profit, 0);
            const totalOutstanding = properties.filter(p => p.status === 'Financed').reduce((s, p) => s + getBalance(p), 0);
            const totalCollected = payments.reduce((s, p) => s + (p.amountPaid || 0), 0);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && profitData.length > 0) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'bar',
                        data: { labels: profitData.map(d => d.name), datasets: [{ label: 'Profit', data: profitData.map(d => d.profit), backgroundColor: profitData.map(d => d.profit >= 0 ? '#22c55e' : '#ef4444') }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [properties]);

            return (
                <div>
                    <h2 className="text-lg font-semibold mb-3">Reports</h2>
                    <div className="grid grid-cols-3 gap-3 mb-4">
                        <div className="card stat-card"><div className="stat-value text-green">{fmt(totalProfit)}</div><div className="stat-label">Total Profit</div></div>
                        <div className="card stat-card"><div className="stat-value text-orange">{fmt(totalOutstanding)}</div><div className="stat-label">Outstanding</div></div>
                        <div className="card stat-card"><div className="stat-value text-blue">{fmt(totalCollected)}</div><div className="stat-label">Collected</div></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-3">Profit by Deal</h3>
                            <div style={{ height: '200px' }}><canvas ref={chartRef}></canvas></div>
                        </div>
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-3">Profit Details</h3>
                            <div className="space-y-2 text-sm max-h-48 overflow-auto">
                                {profitData.map((d, i) => (
                                    <div key={i} className="flex justify-between py-1 border-b border-gray-100">
                                        <span>{d.name}</span>
                                        <span className={d.profit >= 0 ? 'text-green font-medium' : 'text-red font-medium'}>{fmt(d.profit)}</span>
                                    </div>
                                ))}
                                {profitData.length === 0 && <p className="text-gray-500">No sold properties yet</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============== SETTINGS ==============
        const Settings = ({ currentUser, store, onLogout }) => {
            const exportData = () => {
                const data = { properties: store.properties, payments: store.payments, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mh-backup-${today()}.json`; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.properties) localStorage.setItem('mh_properties_v2', JSON.stringify(d.properties)); if (d.payments) localStorage.setItem('mh_payments_v2', JSON.stringify(d.payments)); window.location.reload(); } catch (err) { alert('Invalid file'); } };
                reader.readAsText(file);
            };

            return (
                <div>
                    <h2 className="text-lg font-semibold mb-3">Settings</h2>
                    <div className="grid gap-4 max-w-md">
                        <div className="card p-4">
                            <div className="flex items-center gap-3"><div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">{currentUser[0]}</div><div><div className="font-medium">{currentUser}</div><div className="text-xs text-gray-500">Logged in</div></div></div>
                        </div>
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-3">Data Management</h3>
                            <div className="space-y-2">
                                <button className="btn btn-secondary w-full flex items-center justify-center gap-2" onClick={exportData}><Icon name="download" size={14} /> Export Backup</button>
                                <label className="btn btn-secondary w-full flex items-center justify-center gap-2 cursor-pointer"><Icon name="download" size={14} /> Import Backup<input type="file" accept=".json" className="hidden" onChange={importData} /></label>
                            </div>
                        </div>
                        <div className="card p-4">
                            <h3 className="font-medium text-sm mb-2">Statistics</h3>
                            <div className="text-sm space-y-1">
                                <div className="flex justify-between"><span className="text-gray-500">Properties:</span><span>{store.properties.length}</span></div>
                                <div className="flex justify-between"><span className="text-gray-500">Payments:</span><span>{store.payments.length}</span></div>
                            </div>
                        </div>
                        <button className="btn btn-danger" onClick={onLogout}>Sign Out</button>
                    </div>
                </div>
            );
        };

        // ============== APP ==============
        const App = () => {
            const [loggedIn, setLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState('');
            const [tab, setTab] = useState('dashboard');
            const store = useDataStore();

            useEffect(() => {
                const auth = localStorage.getItem('mh_auth');
                const user = localStorage.getItem('mh_user');
                if (auth && user) { setLoggedIn(true); setCurrentUser(user); }
            }, []);

            const handleLogin = (user) => { setLoggedIn(true); setCurrentUser(user); };
            const handleLogout = () => { localStorage.removeItem('mh_auth'); localStorage.removeItem('mh_user'); setLoggedIn(false); };

            if (!loggedIn) return <Login onLogin={handleLogin} />;
            if (store.loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>;

            return (
                <div className="flex min-h-screen">
                    <div className="sidebar no-print">
                        <div className="p-4 border-b border-gray-800"><div className="text-white font-semibold text-sm">üè† MH Manager</div></div>
                        <nav className="py-2">
                            <div className={`sidebar-item ${tab === 'dashboard' ? 'active' : ''}`} onClick={() => setTab('dashboard')}><Icon name="home" size={18} /> Dashboard</div>
                            <div className={`sidebar-item ${tab === 'properties' ? 'active' : ''}`} onClick={() => setTab('properties')}><Icon name="building" size={18} /> Properties</div>
                            <div className={`sidebar-item ${tab === 'payments' ? 'active' : ''}`} onClick={() => setTab('payments')}><Icon name="dollar" size={18} /> Payments</div>
                            <div className={`sidebar-item ${tab === 'reports' ? 'active' : ''}`} onClick={() => setTab('reports')}><Icon name="chart" size={18} /> Reports</div>
                            <div className={`sidebar-item ${tab === 'settings' ? 'active' : ''}`} onClick={() => setTab('settings')}><Icon name="settings" size={18} /> Settings</div>
                        </nav>
                    </div>
                    <div className="flex-1 p-4 pb-20 md:pb-4 content-area">
                        {tab === 'dashboard' && <Dashboard store={store} />}
                        {tab === 'properties' && <Properties store={store} currentUser={currentUser} />}
                        {tab === 'payments' && <Payments store={store} currentUser={currentUser} />}
                        {tab === 'reports' && <Reports store={store} />}
                        {tab === 'settings' && <Settings currentUser={currentUser} store={store} onLogout={handleLogout} />}
                    </div>
                    <div className="mobile-nav">
                        <button className={tab === 'dashboard' ? 'active' : ''} onClick={() => setTab('dashboard')}><Icon name="home" size={20} /><div>Dashboard</div></button>
                        <button className={tab === 'properties' ? 'active' : ''} onClick={() => setTab('properties')}><Icon name="building" size={20} /><div>Properties</div></button>
                        <button className={tab === 'payments' ? 'active' : ''} onClick={() => setTab('payments')}><Icon name="dollar" size={20} /><div>Payments</div></button>
                        <button className={tab === 'reports' ? 'active' : ''} onClick={() => setTab('reports')}><Icon name="chart" size={20} /><div>Reports</div></button>
                        <button className={tab === 'settings' ? 'active' : ''} onClick={() => setTab('settings')}><Icon name="settings" size={20} /><div>Settings</div></button>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
